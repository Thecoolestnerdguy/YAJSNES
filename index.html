<html>
<head>
<title> NES Emulator </title>
</head>

<body>

<script type = "text/javascript" src = "cpu.js">
</script>

<input type="file" id = "rom"></input>

<script type = "text/javascript">

var Reader = new FileReader();

var rom = {};

var bla;

var romFile = document.getElementById("rom");
romFile.addEventListener("change",function(e){

  Reader.readAsArrayBuffer(e.target.files[0]);
  Reader.onload = function()
  {
    rawData = new Uint8Array(Reader.result);
    if(rawData[0] << 32 + rawData[1] << 16 + rawData[2] << 8 + rawData[3] === 79872)
    {
      console.log("This is indeed a NES rom!");
      rom.pgrAmount = rawData[4];
      rom.chrAmount = rawData[5];
      rom.hasTrainer = (rawData[6] & 0b00000100) >> 2 === 1 ? true : false;
      rom.header = rawData.subarray(0,16);
      rom.pgrRomOffset = rom.hasTrainer ? 528 : 16;
      if(rom.hasTrainer) rom.trainer = rawData.subarray(16,528);
      var pgrRaw = rawData.subarray(rom.pgrRomOffset,(rom.pgrRomOffset + 1) + (16384 * rom.pgrAmount));
      rom.pgr16kBanks = [];
      rom.pgr8kBanks = [];
      for(x = 0;x < rom.pgrAmount; x++)
      {
        rom.pgr16kBanks[x] = pgrRaw.subarray(16384 * x, 16384 + 16384 * x);
      }
      for(x = 0;x < rom.pgrAmount * 2; x++)
      {
        rom.pgr8kBanks[x] = pgrRaw.subarray(8192 * x, 8192 + 8192 * x);
      }
      rom.rawData = rawData;
      init();
    }

    else console.log("This doesn't seems to be a NES rom...");
  }


});

var init = function()
{
  var mem = new ArrayBuffer(65536);
  var accessMem = new Uint8Array(mem);

  for(x = 0; x < 16384; x++)
  {
    accessMem[0xC000 + x] = rom.pgr16kBanks[rom.pgr16kBanks.length - 1][x];
  }

  var memory = function(address,value)
  {
    if(value === undefined)
    {
     return accessMem[address];
    }
    else accessMem[address] = value;
  }

  console.log(accessMem);

  bla = new CPU(memory);


  window.addEventListener("keydown",function(e){

   if(e.keyCode === 69)
   {
     bla.execute();
     console.log(bla.PC);
   }

  });
}

</script>

</body>

</html>
